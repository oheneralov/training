// WebSocket utility functions
import { ref, type Ref } from 'vue'

// Types
interface QueryParameters {
  token: string | null
  apikey: string | null
}

type LogFunction = (message: string) => void

// WebSocket state
let socket: WebSocket | null = null
const connected: Ref<boolean> = ref(false)

// --- Helper functions ---
function getQueryParameters(): QueryParameters {
  const urlParams = new URLSearchParams(window.location.search)
  return {
    token: urlParams.get('token'),
    apikey: urlParams.get('apikey')
  }
}

function buildWebSocketUrl(): string {
  const baseUrl: string = import.meta.env.VITE_WEBSOCKET_URL || 'ws://localhost:8000/ws'
  const params = getQueryParameters()
  
  // Only add query parameters if they exist
  const queryParams = new URLSearchParams()
  if (params.token) queryParams.append('token', params.token)
  if (params.apikey) queryParams.append('apikey', params.apikey)
  
  const queryString = queryParams.toString()
  return queryString ? `${baseUrl}?${queryString}` : baseUrl
}

// --- WebSocket management functions ---
function initConnection(url: string | null = null, addLog: LogFunction): void {
  if (socket && socket.readyState === WebSocket.OPEN) {
    addLog('WebSocket already open')
    return
  }

  const wsUrl: string = url || buildWebSocketUrl()
  socket = new WebSocket(wsUrl)

  socket.addEventListener('open', () => {
    connected.value = true
    addLog(`Connected to ${wsUrl}`)
  })

  socket.addEventListener('message', (ev: MessageEvent) => {
    addLog('Received: ' + ev.data)
  })

  socket.addEventListener('close', (ev: CloseEvent) => {
    connected.value = false
    addLog(`Socket closed (code=${ev.code})`)
  })

  socket.addEventListener('error', () => {
    addLog('Socket error')
  })
}

function connectSocket(addLog: LogFunction): void {
  try {
    initConnection(null, addLog)
  } catch (err) {
    addLog('Connect failed: ' + err)
  }
}

function disconnectSocket(addLog: LogFunction): void {
  if (!socket) return
  try {
    socket.close()
    socket = null
    connected.value = false
    addLog('Socket closed by client')
  } catch (err) {
    addLog('Error while closing socket: ' + err)
  }
}

function sendWSMessage(payload: string | object, addLog: LogFunction): boolean {
  // ensure payload is string
  const msg: string = typeof payload === 'string' ? payload : JSON.stringify(payload)
  if (!socket || socket.readyState !== WebSocket.OPEN) {
    addLog('Cannot send: socket is not open')
    return false
  }

  try {
    socket.send(msg)
    addLog('Sent: ' + (msg.length > 200 ? msg.slice(0, 200) + '... (truncated)' : msg))
    return true
  } catch (err) {
    addLog('Send failed: ' + err)
    return false
  }
}

// convenience wrapper
function sendMessageToServer(message: string | object, addLog: LogFunction): boolean {
  return sendWSMessage(message, addLog)
}

export {
  connected,
  initConnection,
  connectSocket,
  disconnectSocket,
  sendWSMessage,
  sendMessageToServer
}

export type { QueryParameters, LogFunction }
